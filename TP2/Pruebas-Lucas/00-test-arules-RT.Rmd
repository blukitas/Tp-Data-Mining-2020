---
title: "R Notebook"
output: html_notebook
---


## Librerías

```{r}
library("ggplot2")
library("readr")
library("dplyr")
library("highcharter")
library("treemap")
library("modeest")
library("GGally")
library("tidyverse")
library("hrbrthemes")
library("tidyr")
library("VIM")
library("e1071")
library("mice")
library("mongolite")

library("SnowballC")
library("tm", exclude = "inspect")
library("twitteR")
library("syuzhet")

library("lubridate")

library("RColorBrewer")
#library("infotheo"); # Discretize variable

library('dplyr')
library('tm')
library('stringr')
library('stringi')
library('arules')
#install.packages("arulesViz", type = "source")
library('arulesViz')

```

# Retweets:

```{r}
# tweets <- mongo(collection = "query_compleja_RT", db = "DMUBA")
tweets <- mongo(collection = "query_compleja_RT_Tiempos", db = "DMUBA")
```

```{r}
df_user_features = tweets$find()
```




```{r}
summary(df_user_features)
cat("Cant. de filas: ", nrow(df_user_features))
```

```{r}
names(df_user_features)
```


```{r}
df_user_features$cat_RT_popular = arules::discretize(df_user_features$RT_followers_friends_ratio, breaks=5, labels=c("muy pocos", "pocos", "amigos medios", "muchos", "muy muchos"))
#df_user_features$cat_activo = arules::discretize(df_user_features$postsXyear, breaks=5, labels=c("muy pocos", "pocos", "actividad normal", "muchos", "muy muchos"))
#df_user_features$cat_RT_popular = arules::discretize(df_user_features$RT_followers_friends_ratio, breaks=5, labels=c("muy pocos", "pocos", "medio", "muchos", "muy muchos"))
#df_user_features$cat_dateDifference = arules::discretize(df_user_features$dateDifference_m, breaks=5, labels=c("inmediato", "poco", "tiempo normal", "largo", "desde el pasado"))

df_user_features$cat_vida_RT = arules::discretize(df_user_features$vida_RT, method = "fixed", breaks = c(-Inf, 1, 3, 4, 5, Inf), labels=c("muy corta", "corta","media","larga","muy larga") )

df_user_features$cat_n_char = arules::discretize(df_user_features$retweet_cant_caracteres, breaks=3, labels=c("corto", "medio", "largo"))

df_user_features$cat_cant_RT = discretize(log10(df_user_features$cant_RT),method = "fixed", breaks = c(-Inf, 1.5, 3, Inf), labels=c("baja", "media", "alta"))

df_user_features$cat_duracion_RT = arules::discretize(df_user_features$duracion_RT,method = "fixed", breaks = c(-Inf, 1, 3, 4, 5, Inf), labels=c("muy poca", "poca","media","larga","muy larga") )

df_user_features$cat_1_resp = arules::discretize(df_user_features$tiempo_primera_rpta_RT_m,method = "fixed", breaks = c(-Inf, 1, 3, 4, 5, Inf), labels=c("rapidisima","muy rapida", "rapida", "lenta", "muy lenta") )


df_user_features$cat_adherencia = arules::discretize(df_user_features$retweet_favorite_count,method = "fixed", c(-Inf,0.69, 1.69, 2.69, 3.69, Inf), labels = c("muy_baja", "baja", "intermedia", "alta", "muy_alta"))

df_user_features$cat_difusion = arules::discretize(df_user_features$retweet_retweet_count,method = "fixed", c(-Inf,1, 2, 3, Inf), labels = c("muy_baja", "baja", "intermedia", "alta"))


```

```{r}
df_user_features$cat_retweet_verified <- ifelse(df_user_features$cat_retweet_verified, "Verificados", "Sin verificar")
df_user_features$cat_retweet_verified <- as.factor(df_user_features$cat_retweet_verified)
```



```{r}
names(df_user_features) 

columnas_transacciones <- c(
  "cat_fecha_inicio_T_momento",
  "cat_retweet_es_finde",
  "cat_retweet_verified",
  "cat_retweet_source",
  "cat_n_char",
  "cat_cant_RT",
  "cat_RT_popular",
  "cat_duracion_RT",
  "cat_vida_RT",
  "cat_1_resp",
  "cat_adherencia",
  "cat_difusion"
)
```


```{r}

df_user_tuples = df_user_features %>% 
  pivot_longer(
    #cols = columnas_transacciones,
    cols = starts_with("cat"),
    names_to = "feat", 
    values_to = "val", 
    names_prefix = "cat_",
    values_drop_na = TRUE) %>% 
    dplyr::select("retweet_status_id", "feat", "val")
#df_user_tuples = df_user_tuples[ c("user_id", "feat", "val") ]
  
names(df_user_tuples)
# se agrega prefijo de tipo de Ã�tem:
df_user_tuples <- df_user_tuples %>% 
  mutate("item" = paste0(feat,"=",val)) %>% 
  dplyr::select("retweet_status_id", "item")

length(unique(df_user_tuples$retweet_status_id))

```
## Correlacion datos numericos
```{r}
num_cols <- unlist(lapply(df_user_features, is.numeric))  
# ggpairs(df_user_features[,num_cols])
# No hay ninguna correlacion fuerte acá.
```

## Correlacion datos categoricos
```{r}
#   cat_cols <- c(
#                 "cat_created_at_momento", 
#                 "cat_created_at_dia",
#                 "cat_retweet_created_at_momento",
#                 "cat_retweet_created_at_dia",
#                 "cat_retweet_source",
#                 "cat_activo",
#                 "cat_popular",
#                 "cat_RT_popular")
# 
# library(MASS)
# # for (i in cat_cols) {
#   for (j in cat_cols) { 
#   print("------------------------------------------------------------------")
#   cat("Chi cuadrado para categorica: ", i, " con ", j)
#   if (i == j) {
#     print("Misma col")
#   } else {
#     tbl_cont = table(df_user_features[[i]], df_user_features[[j]])
#     print(tbl_cont)
#     chi_aux <- chisq.test(tbl_cont)
#     print(chi_aux)
#   } 
# }
# }

  
```


```{r}

# reglas de asociaciÃ³n
trans <- as(split(df_user_tuples$item, df_user_tuples$retweet_status_id), "transactions")
#arules::inspect(trans[100])

#trans <- as(df_user_features[columnas_transacciones], "transactions")
rules = apriori(trans, parameter=list(target="rule",  minlen=4, support=0.05, confidence=0.05))
#print(rules)
#arules::inspect(sort(rules, by="lift", decreasing = TRUE))

```

```{r}
plot(rules, measure = c("support", "lift"), shading = "confidence")
```


```{r}
plot(rules, method = "two-key plot")
```

```{r}
itemFrequencyPlot(trans, topN=10, type="absolute", main="Item Frequency") # plot frequeitemFrequencyPlot(Groceries, topN=10, type="absolute", main="Item Frequency") # plot freque
```

```{r}
# View(inspect(sort(rules, by="lift", decreasing = TRUE)[1:100]))
```


```{r}
# aux <- arules::subset(rules, subset=((rhs %pin% "mucha replica")))
aux <- arules::subset(rules, subset=(lift > 2 & support > 0.1))
arules::inspect(head(sort(aux, by="count", decreasing = TRUE), 5))
```

```{r}
arules::inspect(head(sort(aux, by="lift", decreasing = TRUE), 5))
```

```{r}
arules::inspect(head(sort(aux, by="confidence", decreasing = TRUE), 5))
```

```{r}
arules::inspect(head(sort(aux, by="coverage", decreasing = TRUE), 5))
```
